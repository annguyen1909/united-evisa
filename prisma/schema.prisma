generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id    String @id @default(uuid())
  name  String
  email String @unique
  role  String
}

model Account {
  id                    String                  @id @default(uuid())
  createdAt             DateTime                @default(now())
  updatedAt             DateTime?
  email                 String
  fullName              String                  @default("Unknown")
  areaCode              String                  @default("+1")
  phoneNumber           String                  @default("Unknown")
  gender                String                  @default("Unknown")
  password              String?
  emailVerified         Boolean                 @default(false)
  websiteCreatedAt      String                  @default("Sri Lanka Local Site")
  applications          Application[]
  cases                 Case[]
  password_reset_tokens password_reset_tokens[]
  sessions              sessions[]

  @@unique([email, websiteCreatedAt])
  @@index([fullName])
  @@index([phoneNumber])
  @@index([websiteCreatedAt])
  @@index([email])
}

model Destination {
  id           String        @id @default(uuid())
  name         String        @unique
  code         String?
  applications Application[]
  visaTypes    VisaType[]

  @@index([name])
}

model VisaType {
  id                      String                    @id @default(uuid())
  name                    String
  waitTime                String?
  fees                    Float?
  requiredDocuments       String?
  allowedNationalities    Json?
  destinationId           String
  applications            Application[]
  destination             Destination               @relation(fields: [destinationId], references: [id])
  VisaTypeNationalityFees VisaTypeNationalityFees[]

  @@unique([name, destinationId])
  @@index([name])
}

model CardHolder {
  id            String      @id @default(uuid())
  name          String
  cardType      String
  cardNumber    String
  address       String
  zipcode       String
  applicationId String      @unique
  application   Application @relation(fields: [applicationId], references: [id])
}

model Application {
  id                   String                @id @default(uuid())
  destinationId        String
  visaTypeId           String
  status               String
  accountId            String
  createdAt            DateTime              @default(now())
  updatedAt            DateTime?
  applicationId        String                @unique
  passengerCount       Int?
  stayingEnd           DateTime?
  stayingStart         DateTime?
  total                Float?
  cancellationDetails  String?
  cancellationReason   String?
  cancelledAt          DateTime?
  cancelledBy          String?
  applyDate            DateTime?
  paymentStatus        String?
  portType             String?
  portName             String?
  account              Account               @relation(fields: [accountId], references: [id])
  destination          Destination           @relation(fields: [destinationId], references: [id])
  visaType             VisaType              @relation(fields: [visaTypeId], references: [id])
  applicationDocuments ApplicationDocument[]
  cardHolder           CardHolder?
  cases                Case[]
  customRequirements   CustomRequirement[]
  passengers           Passenger[]
  risks                Risk[]
  stripeActivity       StripeActivity[]      @relation("ApplicationToStripeActivity")

  @@index([applicationId])
}

model Passenger {
  id             String      @id @default(uuid())
  applicationId  String
  createdAt      DateTime    @default(now())
  passportNumber String?
  updatedAt      DateTime?
  dateOfBirth    DateTime?
  fullName       String?
  gender         String?
  nationality    String?
  status         String?
  application    Application @relation(fields: [applicationId], references: [id])

  @@index([fullName])
}

model Risk {
  id            String         @id @default(uuid())
  status        String
  applicationId String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime?
  lastUpdated   DateTime?
  application   Application    @relation(fields: [applicationId], references: [id])
  activities    RiskActivity[]
  documents     RiskDocument[]
}

model RiskActivity {
  id          String    @id @default(uuid())
  riskId      String
  createdAt   DateTime  @default(now())
  description String?
  type        String?
  details     String?
  timestamp   DateTime?
  title       String?
  risk        Risk      @relation(fields: [riskId], references: [id])
}

model RiskDocument {
  id         String   @id @default(cuid())
  name       String
  riskId     String
  createdAt  DateTime @default(now())
  status     String   @default("Pending")
  updatedAt  DateTime @updatedAt
  type       String
  uploadedAt DateTime @default(now())
  uploadedBy String?
  content    Bytes
  risk       Risk     @relation(fields: [riskId], references: [id])

  @@index([riskId])
}

model StripeActivity {
  id                    String       @id @default(uuid())
  title                 String?
  amount                Float?
  createdAt             DateTime     @default(now())
  status                String?
  type                  String?
  applicationId         String?
  description           String?
  timestamp             DateTime?
  transactionId         String?
  govFeeRefund          Decimal?     @db.Decimal(10, 2)
  serviceFeeRefund      Decimal?     @db.Decimal(10, 2)
  originalTransactionId String?
  application           Application? @relation("ApplicationToStripeActivity", fields: [applicationId], references: [id])
}

model ApplicationDocument {
  id            String           @id @default(cuid())
  applicationId String
  name          String
  type          String
  content       Bytes
  status        String?          @default("Pending")
  uploadedAt    DateTime         @default(now())
  uploadedBy    String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  caseId        String?
  application   Application      @relation(fields: [applicationId], references: [id])
  case          Case?            @relation(fields: [caseId], references: [id])
  mapping       DocumentMapping?

  @@index([applicationId])
  @@index([caseId])
}

model DocumentMapping {
  id             String              @id @default(cuid())
  documentId     String              @unique
  mappedTo       String?
  isInvalid      Boolean             @default(false)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  mappedAtStatus String?
  document       ApplicationDocument @relation(fields: [documentId], references: [id])

  @@index([documentId])
}

model CustomRequirement {
  id            String      @id @default(uuid())
  applicationId String
  passengerId   String
  title         String
  createdAt     DateTime    @default(now())
  application   Application @relation(fields: [applicationId], references: [id])
}

model Task {
  id              String         @id @default(uuid())
  title           String
  description     String?
  assignedTo      String?
  assignedToEmail String?
  dueDate         DateTime?
  taskType        String?
  status          String         @default("Active")
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  taskId          String         @unique
  entityType      String?
  entityId        String?
  submittedBy     String         @default("ee397d6b-60aa-447f-afde-94446e32b0f5")
  activities      TaskActivity[]

  @@index([entityType])
  @@index([entityType, entityId])
}

model TaskActivity {
  id          String   @id @default(uuid())
  taskId      String
  status      String
  description String
  timestamp   DateTime @default(now())
  createdAt   DateTime @default(now())
  task        Task     @relation(fields: [taskId], references: [id])

  @@index([taskId])
}

model Case {
  id                   String                @id
  gmailThreadId        String?               @unique
  email                String
  subject              String
  status               String                @default("Open")
  lastUpdate           DateTime              @default(now()) @updatedAt
  websiteCreatedAt     String
  accountId            String?
  applicationId        String?
  assignedTo           String?
  topic                String?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  applicationDocuments ApplicationDocument[]
  account              Account?              @relation(fields: [accountId], references: [id])
  application          Application?          @relation(fields: [applicationId], references: [id])
  emailThreads         EmailThread[]

  @@index([email])
  @@index([websiteCreatedAt])
  @@index([status])
  @@index([assignedTo])
}

model EmailTemplate {
  id               String   @id @default(uuid())
  name             String
  subject          String
  body             String
  websiteCreatedAt String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([websiteCreatedAt])
}

model EmailThread {
  id          String       @id @default(uuid())
  caseId      String
  messageId   String
  fromEmail   String
  toEmail     String
  subject     String
  body        String
  timestamp   DateTime     @default(now())
  direction   String
  cc          String?
  bcc         String?
  attachments Attachment[]
  case        Case         @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@index([caseId])
  @@index([timestamp])
  @@index([messageId])
}

model Attachment {
  id            String      @id @default(uuid())
  emailThreadId String
  filename      String
  content       Bytes
  createdAt     DateTime    @default(now())
  emailThread   EmailThread @relation(fields: [emailThreadId], references: [id], onDelete: Cascade)

  @@index([emailThreadId])
}

model CaseSequence {
  year            Int      @id
  currentSequence Int?     @default(0)
  updatedAt       DateTime @default(now()) @updatedAt
}

model password_reset_tokens {
  id        String   @id
  accountId String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  Account   Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
}

model sessions {
  id        String   @id
  accountId String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  Account   Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
}

model WebsiteHealthCheck {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  url       String
  status    String
  code      Int?
  latency   Int?
  checkedAt DateTime @default(now()) @db.Timestamptz(6)
  error     String?
}

model SystemHealthIncident {
  id           Int       @id @default(autoincrement())
  service_name String    @db.VarChar(255)
  incident_id  String    @db.VarChar(255)
  started_at   DateTime  @default(now()) @db.Timestamp(6)
  resolved_at  DateTime? @db.Timestamp(6)
  last_status  String    @db.VarChar(16)

  @@unique([service_name, incident_id])
  @@map("SystemHealthIncident")
}

model ChatSession {
  id                   String        @id @default(uuid())
  status               String        @default("active")
  siteId               String
  handled              Boolean       @default(false)
  friendlyId           String?       @unique
  visitorName          String?
  createdAt            DateTime      @default(now())
  hidden               Boolean       @default(false)
  updatedAt            DateTime      @updatedAt
  visitorId            String
  lastVisitorMessageAt DateTime?
  lastAgentMessageAt   DateTime?
  messages             ChatMessage[]

  @@index([status])
  @@index([visitorId])
  @@index([handled])
  @@index([hidden])
}

model ChatMessage {
  id           String          @id @default(uuid())
  content      String
  senderName   String?
  deliveredAt  DateTime?
  readAt       DateTime?
  attachmentId String?
  senderId     String?
  senderType   String
  sentAt       DateTime        @default(now())
  sessionId    String
  type         String          @default("text")
  attachment   ChatAttachment?
  session      ChatSession     @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([sentAt])
  @@index([senderType])
}

model ChatAttachment {
  id        String       @id @default(uuid())
  messageId String?      @unique
  filename  String
  size      Int
  type      String
  createdAt DateTime     @default(now())
  content   Bytes
  message   ChatMessage? @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
}

model VisaTypeNationalityFees {
  id             String   @id
  visaTypeId     String
  nationality    String
  governmentFees Decimal  @db.Decimal(10, 2)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @default(now())
  VisaType       VisaType @relation(fields: [visaTypeId], references: [id], onDelete: Cascade)

  @@unique([visaTypeId, nationality])
  @@index([nationality])
  @@index([visaTypeId])
}
